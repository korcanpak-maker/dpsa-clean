
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DPSA Yönetim PRO</title>
<style>
:root{
  --bg:#0b0f1a; --fg:#e7ecff; --muted:#a8b3cf; --card:#121b2e; --border:#1d2a44; --brand:#4f8cff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
a{color:inherit;text-decoration:none}
.container{max-width:1160px;margin:0 auto;padding:16px}
.topbar{display:flex;align-items:center;gap:.6rem;justify-content:space-between}
.brand{font-weight:800;letter-spacing:.3px}
nav{display:flex;gap:.5rem;flex-wrap:wrap}
nav a{padding:.45rem .7rem;border:1px solid var(--border);border-radius:8px;background:#0e1526}
nav a.active{border-color:rgba(79,140,255,.6);background:rgba(79,140,255,.12)}

.grid{display:grid;gap:16px}
.cards{grid-template-columns:repeat(4,1fr)}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
.card h3{margin:0 0 8px 0;font-size:.95rem;color:var(--muted)}
.kpi{font-weight:800;font-size:20px}

.calbar{display:flex;align-items:center;gap:.5rem;margin:8px 0 12px}
.btn,.btn-outline{padding:.35rem .7rem;border-radius:8px;border:1px solid var(--border);background:#0f1628;color:var(--fg);cursor:pointer}
.btn:disabled,.btn-outline:disabled{opacity:.6;cursor:not-allowed}
.btn-outline.active{background:rgba(79,140,255,.15);border-color:rgba(79,140,255,.6)}
.cal-mode{display:flex;gap:.25rem;margin-right:.5rem}
.cal-range{color:var(--muted);font-weight:700}

.calhead{display:grid;grid-template-columns:120px repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-bottom:0}
.calhead .cell{background:#0f1320;color:var(--muted);padding:.5rem;text-align:center;font-weight:700}
.calgrid{display:grid;grid-template-columns:120px repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border)}
.cal-timecol{background:#0f1320}
.cal-time{height:32px;padding:8px;color:var(--muted);font-size:.85rem;border-bottom:1px solid #0e1a31}
.cal-day{position:relative;background:#0f1320}
.cal-day .cal-hour{height:32px;border-bottom:1px dashed #0e1a31}
.event{position:absolute;left:4px;right:4px;border:1px solid rgba(79,140,255,.5);background:rgba(79,140,255,.12);border-radius:8px;padding:6px 8px;min-height:36px;display:flex;flex-direction:column;justify-content:center}
.badge{display:inline-block;padding:2px 6px;border:1px solid rgba(79,140,255,.6);border-radius:999px;font-size:.72rem;margin-left:6px}

.month-header{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-bottom:0;margin-top:8px}
.month-header .cell{background:#0f1320;color:var(--muted);padding:.5rem;text-align:center;font-weight:700}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border)}
.month-cell{background:#0f1320;min-height:120px;position:relative;padding:.35rem}
.month-cell .mday{position:absolute;top:4px;right:6px;color:var(--muted);font-size:.75rem}
.pill{display:block;border:1px solid rgba(79,140,255,.5);background:rgba(79,140,255,.15);border-radius:6px;padding:2px 4px;margin-top:2px;font-size:.72rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.list-table{width:100%;border-collapse:collapse;font-size:.95rem;margin-top:6px}
.list-table th,.list-table td{border:1px solid var(--border);padding:.45rem .6rem}
.list-date-row td{background:#0f1320;font-weight:700}
.list-wrap{max-height:600px;overflow:auto}

/* make week grid not too tall */
#calendar{max-height:560px;overflow:auto}

.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--border);padding:.45rem .6rem}
.muted{color:var(--muted)}
footer{color:var(--muted);font-size:.85rem;margin-top:24px}

/* Modal */
dialog.modal{border:1px solid var(--border);background:#0f1320;color:var(--fg);border-radius:12px;padding:0;max-width:560px;width:96%}
.modal header{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
.modal .body{padding:14px;display:grid;gap:10px}
.modal .row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center}
.modal footer{display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border)}
.modal input,.modal select,.modal textarea{width:100%;padding:.5rem;border-radius:8px;border:1px solid var(--border);background:#0e1626;color:var(--fg)}
.modal .chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{border:1px solid var(--border);padding:2px 6px;border-radius:999px;font-size:.8rem;background:#0e1526}
.btn-sm{padding:.25rem .5rem;font-size:.85rem}
.table td.actions{white-space:nowrap}
/* small util */
.flex-between{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">DPSA<span style="color:var(--brand)">Yönetim</span> PRO</div>
    <nav id="nav">
      <a href="#dashboard">Panel</a>
      <a href="#students">Öğrenciler</a>
      <a href="#teachers">Öğretmenler</a>
      <a href="#courses">Dersler/Branşlar</a>
      <a href="#enrollments">Kayıtlar</a>
      <a href="#payments">Ödemeler</a>
      <a href="#payouts">Öğretmen Hakediş</a>
      <a href="#settings">Ayarlar</a>
    </nav>
  </div>

  <!-- DASHBOARD -->
  <section id="dashboard" class="page">
    <div class="grid cards">
      <div class="card"><h3>Öğrenci</h3><div class="kpi" id="kpiStudents">0</div></div>
      <div class="card"><h3>Öğretmen</h3><div class="kpi" id="kpiTeachers">0</div></div>
      <div class="card"><h3>Ders</h3><div class="kpi" id="kpiCourses">0</div></div>
      <div class="card"><h3>Toplam Tahsilat</h3><div class="kpi" id="kpiRevenue">₺0,00</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="calbar">
        <div class="cal-mode">
          <button class="btn-outline active" id="modeWeek">Hafta</button>
          <button class="btn-outline" id="modeMonth">Ay</button>
          <button class="btn-outline" id="modeList">Liste</button>
        </div>
        <button class="btn" id="calPrev">←</button>
        <div class="cal-range" id="calRange">—</div>
        <button class="btn" id="calNext">→</button>
        <button class="btn" id="calToday" style="margin-left:auto">Bugün</button>
      </div>

      <div class="calhead" id="calHeader"></div>
      <div class="calgrid" id="calendar"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Bu ay</h3>
      <div id="monthSummary" class="muted">—</div>
    </div>
  </section>

  <!-- STUDENTS -->
  <section id="students" class="page" hidden>
    <div class="card">
      <div class="flex-between"><h3>Öğrenciler</h3><button class="btn-outline btn-sm" id="btnAddStudent">+ Yeni Öğrenci</button></div>
      <table class="table" id="tblStudents"><thead><tr><th>Ad Soyad</th><th>Telefon</th><th>E-posta</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- TEACHERS -->
  <section id="teachers" class="page" hidden>
    <div class="card">
      <div class="flex-between"><h3>Öğretmenler</h3><button class="btn-outline btn-sm" id="btnAddTeacher">+ Yeni Öğretmen</button></div>
      <table class="table" id="tblTeachers"><thead><tr><th>Ad Soyad</th><th>Telefon</th><th>E-posta</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- COURSES -->
  <section id="courses" class="page" hidden>
    <div class="card">
      <div class="flex-between"><h3>Dersler/Branşlar</h3><button class="btn-outline btn-sm" id="btnAddCourse">+ Yeni Ders</button></div>
      <table class="table" id="tblCourses"><thead><tr><th>Ders</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ENROLLMENTS -->
  <section id="enrollments" class="page" hidden>
    <div class="card">
      <div class="flex-between"><h3>Kayıtlar</h3><button class="btn-outline btn-sm" id="btnAddEnroll">+ Yeni Kayıt</button></div>
      <table class="table" id="tblEnrolls"><thead><tr><th>Öğrenci</th><th>Ders</th><th>Öğretmen</th><th>Gün/Saat</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- PAYMENTS -->
  <section id="payments" class="page" hidden>
    <div class="card">
      <h3>Ödemeler</h3>
      <table class="table" id="tblPayments"><thead><tr><th>Tarih</th><th>Öğrenci</th><th>Tutar</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- PAYOUTS -->
  <section id="payouts" class="page" hidden>
    <div class="card"><h3>Öğretmen Hakediş</h3><div class="muted">Yakında.</div></div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="page" hidden>
    <div class="card"><h3>Ayarlar</h3><div class="muted">Akademi adı vb. (mevcut veriden okunur).</div></div>
  </section>

  
<!-- Modal -->
<dialog class="modal" id="modal">
  <form method="dialog">
    <header id="modalTitle">Form</header>
    <div class="body" id="modalBody"></div>
    <footer>
      <button class="btn-outline" id="btnCancel" value="cancel">Vazgeç</button>
      <button class="btn" id="btnSave" value="default">Kaydet</button>
    </footer>
  </form>
</dialog>

<footer>© 2025 DPSA Yönetim PRO.</footer>
</div>

<script>
// ----------------- Basit veri okuma -----------------
function readDB(){
  try{
    const raw = localStorage.getItem('dpsa_v11');
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function currency(n){
  try{
    return (n||0).toLocaleString('tr-TR',{style:'currency',currency:'TRY',minimumFractionDigits:2});
  }catch(e){ return '₺'+(n||0); }
}
function byId(arr, id){ return (arr||[]).find(x=>x.id===id); }
window.byId = byId; // calendar kullanıyor

// --- demo veri (sadece ilk açılışta yoksa) ---
(function ensureDemo(){
  if(localStorage.getItem('dpsa_v11')) return;
  const now = new Date();
  const monday = getMonday(now);
  const d1 = new Date(monday); d1.setDate(monday.getDate()+1); d1.setHours(13,0,0,0); // Sal 13:00
  const d2 = new Date(monday); d2.setDate(monday.getDate()+3); d2.setHours(19,0,0,0); // Per 19:00
  const db = {
    settings:{academyName:'DILARA PAK SANAT AKADEMİ', defaultShare:50},
    students:[{id:'s1',name:'AHMET'},{id:'s2',name:'KORCAN'},{id:'s3',name:'MERVE'},{id:'s4',name:'VELİ'}],
    teachers:[{id:'t1',name:'TUTKU'},{id:'t2',name:'DİLARA'},{id:'t3',name:'AYŞE'}],
    courses:[{id:'c1',title:'PİYANO'},{id:'c2',title:'KEMAN'},{id:'c3',title:'GİTAR'}],
    enrollments:[
      {id:'e1',studentId:'s1',courseId:'c1',teacherId:'t1',schedule:'Salı 13:00',duration:60,sessions:[{dt:d1.toISOString()}]},
      {id:'e2',studentId:'s2',courseId:'c1',teacherId:'t2',schedule:'Salı 15:00',duration:60},
      {id:'e3',studentId:'s3',courseId:'c2',teacherId:'t3',schedule:'Perşembe 16:00',duration:60,sessions:[{dt:d2.toISOString()}]},
    ],
    payments:[{id:'p1',studentId:'s1',amount:7800,date:now.toISOString()}]
  };
  localStorage.setItem('dpsa_v11', JSON.stringify(db));
})();

// ----------------- Sayfalar -----------------

// ----------------- CRUD Utilities -----------------
function uid(){ return Math.random().toString(36).slice(2,10); }
function saveDB(db){ localStorage.setItem('dpsa_v11', JSON.stringify(db)); }
function saveAndRender(){ saveDB(window.db); renderAll(); dpsaCalRender?.(); }

const modal = { el:null, body:null, title:null, onSave:null };
(function initModal(){
  modal.el = document.getElementById('modal');
  modal.body = document.getElementById('modalBody');
  modal.title= document.getElementById('modalTitle');
  document.getElementById('btnSave').addEventListener('click', e=>{
    if(typeof modal.onSave==='function'){ 
      const ok = modal.onSave();
      if(ok!==false) modal.el.close();
    } else modal.el.close();
  });
  document.getElementById('btnCancel').addEventListener('click', ()=> modal.el.close());
})();

function openStudentForm(item){
  modal.title.textContent = item? 'Öğrenci Düzenle' : 'Yeni Öğrenci';
  modal.body.innerHTML = `
    <div class="row"><label>Ad Soyad</label><input id="f_name" value="${item?.name||''}" required></div>
    <div class="row"><label>Telefon</label><input id="f_phone" value="${item?.phone||''}"></div>
    <div class="row"><label>E-posta</label><input id="f_email" value="${item?.email||''}"></div>
  `;
  modal.onSave = ()=>{
    const name = document.getElementById('f_name').value.trim();
    if(!name){ alert('Ad Soyad gerekli'); return false; }
    if(item){ item.name=name; item.phone=document.getElementById('f_phone').value; item.email=document.getElementById('f_email').value; }
    else{ window.db.students.push({id:uid(), name, phone:document.getElementById('f_phone').value, email:document.getElementById('f_email').value}); }
    saveAndRender();
  };
  modal.el.showModal();
}
function openTeacherForm(item){
  modal.title.textContent = item? 'Öğretmen Düzenle' : 'Yeni Öğretmen';
  modal.body.innerHTML = `
    <div class="row"><label>Ad Soyad</label><input id="f_name" value="${item?.name||''}" required></div>
    <div class="row"><label>Telefon</label><input id="f_phone" value="${item?.phone||''}"></div>
    <div class="row"><label>E-posta</label><input id="f_email" value="${item?.email||''}"></div>
  `;
  modal.onSave = ()=>{
    const name = document.getElementById('f_name').value.trim();
    if(!name){ alert('Ad Soyad gerekli'); return false; }
    if(item){ item.name=name; item.phone=document.getElementById('f_phone').value; item.email=document.getElementById('f_email').value; }
    else{ window.db.teachers.push({id:uid(), name, phone:document.getElementById('f_phone').value, email:document.getElementById('f_email').value}); }
    saveAndRender();
  };
  modal.el.showModal();
}
function openCourseForm(item){
  modal.title.textContent = item? 'Ders Düzenle' : 'Yeni Ders';
  modal.body.innerHTML = `<div class="row"><label>Ders Adı</label><input id="f_title" value="${item?.title||''}" required></div>`;
  modal.onSave = ()=>{
    const title = document.getElementById('f_title').value.trim();
    if(!title){ alert('Ders adı gerekli'); return false; }
    if(item){ item.title=title; } else { window.db.courses.push({id:uid(), title}); }
    saveAndRender();
  };
  modal.el.showModal();
}
function openEnrollForm(item){
  const sops = (window.db.students||[]).map(s=>`<option value="${s.id}" ${item?.studentId===s.id?'selected':''}>${s.name}</option>`).join('');
  const cops = (window.db.courses ||[]).map(c=>`<option value="${c.id}" ${item?.courseId===c.id?'selected':''}>${c.title}</option>`).join('');
  const tops = (window.db.teachers||[]).map(t=>`<option value="${t.id}" ${item?.teacherId===t.id?'selected':''}>${t.name}</option>`).join('');
  modal.title.textContent = item? 'Kayıt Düzenle' : 'Yeni Kayıt';
  modal.body.innerHTML = `
    <div class="row"><label>Öğrenci</label><select id="f_sid">${sops}</select></div>
    <div class="row"><label>Ders</label><select id="f_cid">${cops}</select></div>
    <div class="row"><label>Öğretmen</label><select id="f_tid">${tops}</select></div>
    <div class="row"><label>Gün/Saat</label><input id="f_schedule" placeholder="Örn: Salı 17:00" value="${item?.schedule||''}"></div>
    <div class="row"><label>Süre (dk)</label><input id="f_dur" type="number" min="15" step="5" value="${item?.duration||60}"></div>
    <div class="row"><label>Tekil Ders (ops.)</label><input id="f_session" type="datetime-local"></div>
    <div class="row"><label></label><small class="muted">İsteğe bağlı tek ders tarihi girerseniz kayıt altına eklenir.</small></div>
  `;
  modal.onSave = ()=>{
    const e = item || {id:uid(), sessions:[]};
    e.studentId = document.getElementById('f_sid').value;
    e.courseId  = document.getElementById('f_cid').value;
    e.teacherId = document.getElementById('f_tid').value;
    e.schedule  = document.getElementById('f_schedule').value.trim();
    e.duration  = Number(document.getElementById('f_dur').value||60);
    const sdt = document.getElementById('f_session').value;
    if(sdt){ e.sessions = (e.sessions||[]); e.sessions.push({dt:new Date(sdt).toISOString(), duration:e.duration}); }
    if(item){ /* updated */ } else { window.db.enrollments.push(e); }
    saveAndRender();
  };
  modal.el.showModal();
}
function doDelete(type, id){
  if(!confirm('Silinsin mi?')) return;
  const list = window.db[type]; const idx = list.findIndex(x=>x.id===id);
  if(idx>-1){ list.splice(idx,1); saveAndRender(); }
}
// ----------------- end CRUD -----------------

function setActiveNav(){
  const h = location.hash || '#dashboard';
  document.querySelectorAll('nav a').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===h));
}
function showPage(){
  const h = location.hash || '#dashboard';
  document.querySelectorAll('.page').forEach(el=>el.hidden = ('#'+el.id)!==h);
  setActiveNav();
}

function renderCounts(db){
  document.getElementById('kpiStudents').textContent = (db.students||[]).length;
  document.getElementById('kpiTeachers').textContent = (db.teachers||[]).length;
  document.getElementById('kpiCourses').textContent = (db.courses||[]).length;
  const m = new Date(); const ym = m.getFullYear()+'-'+String(m.getMonth()+1).padStart(2,'0');
  const sum = (db.payments||[]).filter(p=> (p.date||'').startsWith(ym)).reduce((a,b)=>a+Number(b.amount||0),0);
  document.getElementById('kpiRevenue').textContent = currency(sum);
  document.getElementById('monthSummary').textContent = `${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')} Toplam: ${currency(sum)}`;
}

function renderTables(db){
  // Students
  const sBody = document.querySelector('#tblStudents tbody'); sBody.innerHTML='';
  (db.students||[]).forEach(s=> sBody.innerHTML += `<tr><td>${s.name||''}</td><td>${s.phone||''}</td><td>${s.email||''}</td><td class='actions'><button class='btn-outline btn-sm' onclick='openStudentForm(byId(window.db.students,"${'"+s.id+"'}"))'>Düzenle</button> <button class='btn-outline btn-sm' onclick='doDelete("students","${'"+s.id+"'}")'>Sil</button></td></tr>`);
  // Teachers
  const tBody = document.querySelector('#tblTeachers tbody'); tBody.innerHTML='';
  (db.teachers||[]).forEach(t=> tBody.innerHTML += `<tr><td>${t.name||''}</td><td>${t.phone||''}</td><td>${t.email||''}</td><td class='actions'><button class='btn-outline btn-sm' onclick='openTeacherForm(byId(window.db.teachers,"${'"+t.id+"'}"))'>Düzenle</button> <button class='btn-outline btn-sm' onclick='doDelete("teachers","${'"+t.id+"'}")'>Sil</button></td></tr>`);
  // Courses
  const cBody = document.querySelector('#tblCourses tbody'); cBody.innerHTML='';
  (db.courses||[]).forEach(c=> cBody.innerHTML += `<tr><td>${c.title||''}</td><td class='actions'><button class='btn-outline btn-sm' onclick='openCourseForm(byId(window.db.courses,"${'"+c.id+"'}"))'>Düzenle</button> <button class='btn-outline btn-sm' onclick='doDelete("courses","${'"+c.id+"'}")'>Sil</button></td></tr>`);
  // Enrollments
  const eBody = document.querySelector('#tblEnrolls tbody'); eBody.innerHTML='';
  (db.enrollments||[]).forEach(e=>{
    const stu = byId(db.students,e.studentId)?.name||'';
    const tea = byId(db.teachers,e.teacherId)?.name||'';
    const cou = byId(db.courses, e.courseId )?.title||'';
    eBody.innerHTML += `<tr><td>${stu}</td><td>${cou}</td><td>${tea}</td><td>${e.schedule||''}</td>
      <td class='actions'><button class='btn-outline btn-sm' onclick='openEnrollForm(byId(window.db.enrollments,"${'"+e.id+"'}"))'>Düzenle</button> <button class='btn-outline btn-sm' onclick='doDelete("enrollments","${'"+e.id+"'}")'>Sil</button></td></tr>`;
  });
  // Payments
  const pBody = document.querySelector('#tblPayments tbody'); pBody.innerHTML='';
  (db.payments||[]).forEach(p=>{
    const stu = byId(db.students,p.studentId)?.name||'';
    pBody.innerHTML += `<tr><td>${(p.date||'').slice(0,10)}</td><td>${stu}</td><td>${currency(p.amount||0)}</td></tr>`;
  });
}

// Master render
function renderAll(){
  const db = readDB() || {students:[],teachers:[],courses:[],enrollments:[],payments:[]};
  window.db = db; // calendar okur
  showPage();
  renderCounts(db);
  renderTables(db);

  // Buttons
  document.getElementById('btnAddStudent')?.addEventListener('click', ()=> openStudentForm());
  document.getElementById('btnAddTeacher')?.addEventListener('click', ()=> openTeacherForm());
  document.getElementById('btnAddCourse') ?.addEventListener('click', ()=> openCourseForm());
  document.getElementById('btnAddEnroll') ?.addEventListener('click', ()=> openEnrollForm());

}
window.renderAll = renderAll;
window.addEventListener('hashchange', renderAll);

// -------------------------------------------------------------
// === TAKVİM v15.9 (Hafta / Ay / Liste)  ===
(function(){
  let DPSA_CAL_mode = 'week';
  let DPSA_CAL_ref  = new Date();

  const fmt2  = n => String(n).padStart(2,'0');
  const fmtHM = (h,m) => `${fmt2(h)}:${fmt2(m)}`;
  window.getMonday = (d) => { const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; };
  const DAY_SHORT2 = ['Pzt','Sal','Çar','Per','Cum','Cmt','Paz'];
  const DAY_MAP2 = { 'pazartesi':0,'pzt':0,'pzt.':0,'salı':1,'sali':1,'sal':1,'sal.':1,'çarşamba':2,'carsamba':2,'çar':2,'car':2,'çar.':2,'car.':2,'perşembe':3,'persembe':3,'per':3,'per.':3,'cuma':4,'cum':4,'cum.':4,'cumartesi':5,'cmt':5,'cmt.':5,'pazar':6,'paz':6,'paz.':6 };

  function parseSchedule2(s){
    if(!s) return null;
    let t=(s+'').toLowerCase().replace(/\./g,':').trim(); let dow=null;
    for(const k in DAY_MAP2){ if(t.includes(k)){ dow=DAY_MAP2[k]; break; } }
    const m = t.match(/(\d{1,2})[:](\d{2})/) || t.match(/(\d{1,2})\s*$/);
    let hh=17, mm=0; if(m){ hh=Number(m[1]); mm=Number(m[2]||0); }
    return dow==null? null : { dow, hh, mm };
  }
  function readSessions2(e){
    return (e.sessions||[]).map(s=>{
      const d=new Date(s.dt); if(isNaN(d)) return null;
      return { d, dur:(s.duration ?? e.duration ?? 60) };
    }).filter(Boolean);
  }

  function renderWeek2(){
    const header=document.getElementById('calHeader'), grid=document.getElementById('calendar'), range=document.getElementById('calRange');
    if(!header||!grid||!range) return;
    header.style.display='grid'; grid.style.display='grid';
    document.getElementById('monthHeader')?.remove();
    document.getElementById('monthGrid')?.remove();

    const start = getMonday(DPSA_CAL_ref);
    const end   = new Date(start); end.setDate(end.getDate()+6);
    range.textContent = `${fmt2(start.getDate())}.${fmt2(start.getMonth()+1)} – ${fmt2(end.getDate())}.${fmt2(end.getMonth()+1)}`;

    const days=[null];
    for(let i=0;i<7;i++){ const d=new Date(start); d.setDate(start.getDate()+i); days.push(`<div class="cell">${DAY_SHORT2[i]} ${fmt2(d.getDate())}.${fmt2(d.getMonth()+1)}</div>`); }
    header.innerHTML = days.join('');

    const HSTART=9, HEND=21, H=32;
    let timeCol = '<div class="cal-timecol">';
    for(let h=HSTART; h<=HEND; h++){ timeCol += `<div class="cal-time">${fmt2(h)}:00</div>`; }
    timeCol += '</div>';
    const dayCols=[];

    for(let i=0;i<7;i++){
      let col = `<div class="cal-day" style="height:${(HEND-HSTART+1)*H}px">`;
      for(let h=HSTART; h<=HEND; h++){ col += '<div class="cal-hour"></div>'; }
      for(const e of (window.db?.enrollments||[])){
        for(const s of readSessions2(e)){
          const d0=new Date(start); d0.setDate(start.getDate()+i);
          if(s.d.toDateString()===d0.toDateString()){
            const top=((s.d.getHours()-HSTART)*H)+(s.d.getMinutes()/60)*H;
            const height=Math.max(36,H*(Number(s.dur)/60));
            const stu=(byId(window.db?.students,e.studentId)?.name)||'Öğrenci';
            const tea=(byId(window.db?.teachers,e.teacherId)?.name)||'Öğretmen';
            const cou=(byId(window.db?.courses, e.courseId )?.title)||'Ders';
            col += `<div class="event" style="top:${top}px;height:${height}px">
              <div class="title">${stu} <span class="badge">${cou}</span></div>
              <div class="meta">${tea} · ${fmtHM(s.d.getHours(), s.d.getMinutes())}</div>
            </div>`;
          }
        }
        const p=parseSchedule2(e.schedule);
        if(p && p.dow===i){
          const top=((p.hh-HSTART)*H)+(p.mm/60)*H;
          const height=Math.max(36,H*(Number(e.duration||60)/60));
          const stu=(byId(window.db?.students,e.studentId)?.name)||'Öğrenci';
          const tea=(byId(window.db?.teachers,e.teacherId)?.name)||'Öğretmen';
          const cou=(byId(window.db?.courses, e.courseId )?.title)||'Ders';
          col += `<div class="event" style="top:${top}px;height:${height}px">
            <div class="title">${stu} <span class="badge">${cou}</span></div>
            <div class="meta">${tea} · ${fmtHM(p.hh, p.mm)}</div>
          </div>`;
        }
      }
      col+='</div>'; dayCols.push(col);
    }
    grid.innerHTML = timeCol + dayCols.join('');
  }

  function renderMonth2(){
    const container=document.getElementById('calendar'), header=document.getElementById('calHeader'), range=document.getElementById('calRange');
    if(!container||!header||!range) return;
    header.style.display='none'; container.style.display='block';
    document.getElementById('monthHeader')?.remove();
    document.getElementById('monthGrid')?.remove();

    const mh=document.createElement('div'); mh.id='monthHeader'; mh.className='month-header';
    for(let i=0;i<7;i++){ mh.innerHTML += `<div class="cell">${DAY_SHORT2[i]}</div>`; }
    header.parentNode.insertBefore(mh, container);

    const first=new Date(DPSA_CAL_ref.getFullYear(), DPSA_CAL_ref.getMonth(),1);
    const start=getMonday(first);
    const grid=document.createElement('div'); grid.id='monthGrid'; grid.className='month-grid';

    for(let i=0;i<42;i++){
      const d=new Date(start); d.setDate(start.getDate()+i);
      const inMonth=d.getMonth()===DPSA_CAL_ref.getMonth();
      const cell=document.createElement('div'); cell.className='month-cell';
      cell.innerHTML=`<div class="mday" style="opacity:${inMonth?1:.5}">${fmt2(d.getDate())}</div>`;

      for(const e of (window.db?.enrollments||[])){
        for(const s of readSessions2(e)){
          if(s.d.toDateString()===d.toDateString()){
            const stu=(byId(window.db?.students,e.studentId)?.name)||'';
            const cou=(byId(window.db?.courses, e.courseId )?.title)||'';
            cell.innerHTML += `<span class="pill">${fmtHM(s.d.getHours(), s.d.getMinutes())} · ${stu} <span class="badge">${cou}</span></span>`;
          }
        }
        const p=parseSchedule2(e.schedule);
        const dow=(d.getDay()+6)%7;
        if(p && p.dow===dow){
          const stu=(byId(window.db?.students,e.studentId)?.name)||'';
          const cou=(byId(window.db?.courses, e.courseId )?.title)||'';
          cell.innerHTML += `<span class="pill">${fmtHM(p.hh, p.mm)} · ${stu} <span class="badge">${cou}</span></span>`;
        }
      }
      grid.appendChild(cell);
    }
    container.parentNode.insertBefore(grid, container.nextSibling);
    range.textContent = new Date(DPSA_CAL_ref).toLocaleDateString('tr-TR',{month:'long',year:'numeric'});
  }

  function renderList2(){
    const container=document.getElementById('calendar'), header=document.getElementById('calHeader'), range=document.getElementById('calRange');
    if(!container||!header||!range) return;
    header.style.display='none'; container.style.display='block';
    document.getElementById('monthHeader')?.remove();
    document.getElementById('monthGrid')?.remove();

    const start=getMonday(DPSA_CAL_ref);
    const end=new Date(start); end.setDate(end.getDate()+6);
    range.textContent=`${fmt2(start.getDate())}.${fmt2(start.getMonth()+1)} – ${fmt2(end.getDate())}.${fmt2(end.getMonth()+1)}`;

    const rows=[];
    for(const e of (window.db?.enrollments||[])){
      for(const s of readSessions2(e)){
        if(s.d>=start && s.d<=new Date(end.getFullYear(),end.getMonth(),end.getDate(),23,59,59)){
          rows.push({dt:s.d,student:(byId(window.db?.students,e.studentId)?.name)||'',course:(byId(window.db?.courses,e.courseId)?.title)||'',teacher:(byId(window.db?.teachers,e.teacherId)?.name)||''});
        }
      }
    }
    for(let i=0;i<7;i++){
      const day=new Date(start); day.setDate(start.getDate()+i);
      for(const e of (window.db?.enrollments||[])){
        const p=parseSchedule2(e.schedule); if(!p || p.dow!==i) continue;
        const dt=new Date(day.getFullYear(),day.getMonth(),day.getDate(),p.hh,p.mm);
        rows.push({dt,student:(byId(window.db?.students,e.studentId)?.name)||'',course:(byId(window.db?.courses,e.courseId)?.title)||'',teacher:(byId(window.db?.teachers,e.teacherId)?.name)||''});
      }
    }
    rows.sort((a,b)=> a.dt-b.dt || a.student.localeCompare(b.student));

    let html='<div class="list-wrap"><table class="list-table">';
    html+='<thead><tr><th style="width:140px">TARİH</th><th style="width:90px">SAAT</th><th>ÖĞRENCİ</th><th>DERS</th><th>ÖĞRETMEN</th></tr></thead><tbody>';
    let last=null;
    for(const r of rows){
      const dkey=`${fmt2(r.dt.getDate())}.${fmt2(r.dt.getMonth()+1)}.${r.dt.getFullYear()}`;
      if(dkey!==last){ html+=`<tr class="list-date-row"><td colspan="5">${dkey}</td></tr>`; last=dkey; }
      html+=`<tr><td></td><td>${fmt2(r.dt.getHours())}.${fmt2(r.dt.getMinutes())}</td><td>${r.student}</td><td>${r.course}</td><td>${r.teacher}</td></tr>`;
    }
    if(rows.length===0) html += `<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:1rem">Bu hafta ders bulunamadı.</td></tr>`;
    html+='</tbody></table></div>';
    container.innerHTML=html;
  }

  function renderCalendar2(){
    if(location.hash!=='#dashboard') return;
    if     (DPSA_CAL_mode==='week')  renderWeek2();
    else if(DPSA_CAL_mode==='month') renderMonth2();
    else                              renderList2();
    const w=document.getElementById('modeWeek'), m=document.getElementById('modeMonth'), l=document.getElementById('modeList');
    if(w) w.classList.toggle('active', DPSA_CAL_mode==='week');
    if(m) m.classList.toggle('active', DPSA_CAL_mode==='month');
    if(l) l.classList.toggle('active', DPSA_CAL_mode==='list');
  }
  window.dpsaCalRender = renderCalendar2;

  document.getElementById('modeWeek') ?.addEventListener('click', ()=>{ DPSA_CAL_mode='week';  renderCalendar2(); });
  document.getElementById('modeMonth')?.addEventListener('click', ()=>{ DPSA_CAL_mode='month'; renderCalendar2(); });
  document.getElementById('modeList') ?.addEventListener('click', ()=>{ DPSA_CAL_mode='list';  renderCalendar2(); });
  document.getElementById('calPrev')  ?.addEventListener('click', ()=>{ DPSA_CAL_ref.setDate(DPSA_CAL_ref.getDate() + (DPSA_CAL_mode==='week'?-7:-30)); renderCalendar2(); });
  document.getElementById('calNext')  ?.addEventListener('click', ()=>{ DPSA_CAL_ref.setDate(DPSA_CAL_ref.getDate() + (DPSA_CAL_mode==='week'?+7:+30)); renderCalendar2(); });
  document.getElementById('calToday') ?.addEventListener('click', ()=>{ DPSA_CAL_ref=new Date(); renderCalendar2(); });

  window.addEventListener('hashchange', renderCalendar2);
  const _old = window.renderAll; window.renderAll = function(){ _old(); renderCalendar2(); };
  setTimeout(renderCalendar2,0);
})(); // end calendar
// -------------------------------------------------------------

renderAll();
</script>
</body>
</html>
