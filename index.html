<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DPSA Yönetim PRO</title>
  <meta name="description" content="Öğrenci, öğretmen, ders, kayıt, ödeme ve hakediş yönetimi" />
  <style>

:root{ --bg:#0b0e14; --fg:#eaeef7; --muted:#a8b3cf; --card:#121623; --border:#1d2333; --brand:#4f8cff; }
*{box-sizing:border-box} html,body{margin:0;padding:0} body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
.container{width:min(1200px,92vw);margin:0 auto}
.topbar{position:sticky;top:0;z-index:10;background:rgba(11,14,20,.8);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
.topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:.8rem 0}
.brand{font-size:1.2rem;margin:0} .brand span{color:var(--brand)}
.tabs{display:flex;gap:.6rem;flex-wrap:wrap}
.tabs .tab{padding:.45rem .7rem;border:1px solid var(--border);border-radius:10px;color:var(--muted)}
.tabs .tab.active{border-color:var(--brand);color:var(--fg)}
.page{padding:24px 0}
.hidden{display:none}
.page-head{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
.tools{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
.btn{background:var(--brand); border:1px solid transparent; color:#0b0e14; border-radius:10px; padding:.6rem .9rem; font-weight:700; cursor:pointer}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--fg);border-radius:10px;padding:.5rem .8rem;cursor:pointer}
.table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.table th,.table td{border-bottom:1px solid var(--border);padding:.6rem .7rem;text-align:left}
.table th{background:#0f1320;color:var(--muted);font-weight:700}
.row-actions{display:flex;gap:.4rem}
.form{display:grid;gap:.6rem;min-width:320px}
.form label{display:grid;gap:.3rem;color:var(--muted);font-weight:600}
.form input,.form select{padding:.55rem .7rem;border-radius:10px;border:1px solid var(--border);background:#0d1220;color:var(--fg)}
dialog.modal{border:1px solid var(--border);border-radius:14px;background:var(--card);color:var(--fg);padding:1rem;box-shadow:0 10px 30px rgba(0,0,0,.3)}
.search{min-width:260px}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem}
.inline{display:inline-flex;gap:.4rem;align-items:center}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:.8rem}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem}
.muted{color:var(--muted)}
.footer{padding:24px 0;color:var(--muted);border-top:1px solid var(--border);margin-top:24px}

/* Calendar */
.calendar-card{margin-top:12px}
.cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem}
.cal-controls{display:flex;align-items:center;gap:.5rem}
.cal-range{color:var(--muted);font-weight:700}
.cal-header{display:grid;grid-template-columns:60px repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-bottom:0}
.cal-header .cell{background:#0f1320;color:var(--muted);padding:.5rem;font-weight:700;font-size:.85rem}
.calendar{display:grid;grid-template-columns:60px repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border)}
.cal-timecol,.cal-day{background:#0f1320}
.cal-time{height:48px;border-top:1px solid var(--border);font-size:.75rem;color:var(--muted);padding:2px 4px}
.cal-day{position:relative}
.cal-hour{height:48px;border-top:1px solid var(--border)}
.event{position:absolute;left:6px;right:6px;border-radius:8px;background:rgba(79,140,255,.2);border:1px solid rgba(79,140,255,.6);padding:4px 6px;font-size:.75rem;line-height:1.2;overflow:hidden}
.event .title{font-weight:700}
.event .meta{opacity:.8}
.badge{display:inline-block;border:1px solid rgba(255,255,255,.2);border-radius:6px;padding:0 .3rem;margin-left:.3rem;font-size:.7rem}

</style>
</head>
<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <h1 class="brand">DPSA<span>Yönetim PRO</span></h1>
      <nav class="tabs" id="tabs">
        <a href="#dashboard" class="tab">Panel</a>
        <a href="#students" class="tab">Öğrenciler</a>
        <a href="#teachers" class="tab">Öğretmenler</a>
        <a href="#courses" class="tab">Dersler/Branşlar</a>
        <a href="#enrollments" class="tab">Kayıtlar</a>
        <a href="#payments" class="tab">Ödemeler</a>
        <a href="#payouts" class="tab">Öğretmen Hakediş</a>
        <a href="#settings" class="tab">Ayarlar</a>
      </nav>
      <div id="authArea" class="auth"><small class="muted">Misafir</small></div>
    </div>
  </header>

  <main class="container">
    <section id="dashboard" class="page hidden">
      <h2>Yönetim Paneli</h2>
      <div id="stats" class="stats"></div>
<div class="card calendar-card"><div class="cal-head"><h3>Haftalık Takvim</h3><div class="cal-controls"><button class="btn-outline" id="calPrev">←</button><div id="calRange" class="cal-range"></div><button class="btn-outline" id="calNext">→</button><button class="btn-outline" id="calToday">Bugün</button></div></div><div class="cal-header" id="calHeader"></div><div class="calendar" id="calendar"></div><small class="muted">Format örneği: <b>Salı 17:00</b>. Süre belirtilmezse 60 dk kabul edilir.</small></div>
      <div class="card">
        <h3>Bu ay</h3>
        <div id="financeSummary"></div>
      </div>
    </section>

    <section id="students" class="page hidden">
      <div class="page-head">
        <h2>Öğrenciler</h2>
        <div class="tools">
          <input id="studentSearch" class="search" placeholder="Ara: ad, e-posta, telefon" />
          <button class="btn" data-open="studentModal">+ Yeni Öğrenci</button>
        </div>
      </div>
      <div id="studentTable"></div>
    </section>

    <section id="teachers" class="page hidden">
      <div class="page-head">
        <h2>Öğretmenler</h2>
        <div class="tools">
          <input id="teacherSearch" class="search" placeholder="Ara: ad, branş" />
          <button class="btn" data-open="teacherModal">+ Yeni Öğretmen</button>
        </div>
      </div>
      <div id="teacherTable"></div>
    </section>

    <section id="courses" class="page hidden">
      <div class="page-head">
        <h2>Dersler / Branşlar</h2>
        <div class="tools">
          <input id="courseSearch" class="search" placeholder="Ara: ders adı" />
          <button class="btn" data-open="courseModal">+ Yeni Ders</button>
        </div>
      </div>
      <div id="courseTable"></div>
    </section>

    <section id="enrollments" class="page hidden">
      <div class="page-head">
        <h2>Kayıtlar (Öğrenci ↔ Ders ↔ Öğretmen)</h2>
        <div class="tools">
          <input id="enrollSearch" class="search" placeholder="Ara: öğrenci, ders, öğretmen" />
          <button class="btn" data-open="enrollModal">+ Yeni Kayıt</button>
        </div>
      </div>
      <div id="enrollmentTable"></div>
    </section>

    <section id="payments" class="page hidden">
      <div class="page-head">
        <h2>Öğrenci Ödemeleri</h2>
        <div class="tools">
          <input id="paymentSearch" class="search" placeholder="Ara: öğrenci, ders" />
          <button class="btn" data-open="paymentModal">+ Ödeme Ekle</button>
        </div>
      </div>
      <div id="paymentTable"></div>
    </section>

    <section id="payouts" class="page hidden">
      <div class="page-head">
        <h2>Öğretmen Hakedişleri</h2>
        <div class="tools">
          <label class="inline">Ay: <input type="month" id="payoutMonth" /></label>
          <button class="btn" id="recalcPayouts">↻ Yeniden Hesapla</button>
        </div>
      </div>
      <div id="payoutTable"></div>
    </section>

    <section id="settings" class="page hidden">
      <h2>Ayarlar</h2>
      <form id="settingsForm" class="form">
        <div class="grid2">
          <label>Akademi Adı <input type="text" name="academyName" placeholder="Dilara Pak Sanat Akademi" /></label>
          <label>Varsayılan Öğretmen Payı (%) <input type="number" name="defaultShare" min="0" max="100" step="1" /></label>
        </div>
        <button class="btn" type="submit">Kaydet</button>
      </form>
    </section>
  </main>

  <!-- Modals -->
  <dialog id="studentModal" class="modal">
    <form id="studentForm" class="form">
      <h3>Öğrenci</h3>
      <input type="hidden" name="id" />
      <label>Ad Soyad <input name="name" required /></label>
      <label>Telefon <input name="phone" /></label>
      <label>E-posta <input type="email" name="email" /></label>
      <menu>
        <button class="btn-outline" type="button" data-close>Vazgeç</button>
        <button class="btn" type="submit">Kaydet</button>
      </menu>
    </form>
  </dialog>

  <dialog id="teacherModal" class="modal">
    <form id="teacherForm" class="form">
      <h3>Öğretmen</h3>
      <input type="hidden" name="id" />
      <label>Ad Soyad <input name="name" required /></label>
      <label>Uzmanlık/Branş <input name="expertise" /></label>
      <label>Pay Oranı (%) <input type="number" name="share" min="0" max="100" step="1" placeholder="Boşsa varsayılan"/></label>
      <menu>
        <button class="btn-outline" type="button" data-close>Vazgeç</button>
        <button class="btn" type="submit">Kaydet</button>
      </menu>
    </form>
  </dialog>

  <dialog id="courseModal" class="modal">
    <form id="courseForm" class="form">
      <h3>Ders/Branş</h3>
      <input type="hidden" name="id" />
      <label>Başlık <input name="title" required /></label>
      <label>Ücret (Aylık) <input type="number" name="price" min="0" step="0.01" required /></label>
      <menu>
        <button class="btn-outline" type="button" data-close>Vazgeç</button>
        <button class="btn" type="submit">Kaydet</button>
      </menu>
    </form>
  </dialog>

  <dialog id="enrollModal" class="modal">
    <form id="enrollForm" class="form">
      <h3>Yeni Kayıt</h3>
      <input type="hidden" name="id" />
      <label>Öğrenci <select name="studentId" required></select></label>
      <label>Ders <select name="courseId" required></select></label>
      <label>Öğretmen <select name="teacherId" required></select></label>
      <div class="grid2">
        <label>Başlangıç <input type="date" name="startDate" required /></label>
        <label>Pay Oranı (kayıt için, % - opsiyonel) <input type="number" name="shareOverride" min="0" max="100" step="1" /></label>
      </div>
      <label>Süre (dakika) <input type="number" name="duration" min="15" step="15" placeholder="60" /></label>
      <div class="card" style="background:#0f1320;border:1px dashed var(--border)">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap">
          <strong>Tekil Ders Tarihleri (opsiyonel, en fazla 4)</strong>
          <button class="btn-outline" type="button" id="addSession">+ Tarih/Saat Ekle</button>
        </div>
        <div id="sessionList" class="session-list" style="display:grid;gap:.5rem;margin-top:.5rem"></div>
        <small class="muted">Her satıra tarih & saat ekleyin. Süre boşsa kayıt süresi (dakika) kullanılır.</small>
      </div>
      <label>Gün/Saat <input name="schedule" placeholder="Örn: Salı 17:00"/></label>
      <menu>
        <button class="btn-outline" type="button" data-close>Vazgeç</button>
        <button class="btn" type="submit">Kaydet</button>
      </menu>
    </form>
  </dialog>

  <dialog id="paymentModal" class="modal">
    <form id="paymentForm" class="form">
      <h3>Ödeme</h3>
      <input type="hidden" name="id" />
      <label>Öğrenci <select name="studentId" required></select></label>
      <label>Ders <select name="courseId" required></select></label>
      <div class="grid2">
        <label>Tutar <input type="number" name="amount" min="0" step="0.01" required/></label>
        <label>Tarih <input type="date" name="date" required/></label>
      </div>
      <label>Tip
        <select name="method">
          <option>Nakit</option>
          <option>Kart</option>
          <option>Havale</option>
        </select>
      </label>
      <menu>
        <button class="btn-outline" type="button" data-close>Vazgeç</button>
        <button class="btn" type="submit">Kaydet</button>
      </menu>
    </form>
  </dialog>

  <footer class="footer container">
    <small>© <span id="year"></span> DPSA Yönetim PRO.</small>
  </footer>

  <script>

document.addEventListener('DOMContentLoaded', function() {
  try {
    console.log('DPSA v14.1 init start');

console.log('DPSA app.js v11 loaded');
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
function uid(){ return 'id_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
const TL = n => new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY'}).format(Number(n||0));
$('#year').textContent = new Date().getFullYear();

/* Data */
const dataShape = () => ({
  settings: { academyName: "Dilara Pak Sanat Akademi", defaultShare: 50 },
  students: [], teachers: [], courses: [],
  enrollments: [], // {id, studentId, courseId, teacherId, startDate, shareOverride?, schedule}
  payments: []     // {id, studentId, courseId, amount, date, method}
});
const store = {
  key: 'dpsa_v11',
  load(){ try { return JSON.parse(localStorage.getItem(this.key)) || dataShape(); } catch(e){ return dataShape(); } },
  save(d){ localStorage.setItem(this.key, JSON.stringify(d)); }
};
let db = store.load();

/* Routing */
function showPage(hash){
  const target = (hash || location.hash || '#dashboard').split('?')[0];
  $$('.page').forEach(p => p.classList.add('hidden'));
  $$('.tabs .tab').forEach(a => a.classList.remove('active'));
  $(target)?.classList.remove('hidden');
  $(`.tabs .tab[href="${target}"]`)?.classList.add('active');
  renderAll();
}
window.addEventListener('hashchange', ()=>showPage(location.hash));
showPage(location.hash||'#students');

/* UX: dialog close on backdrop + ESC + data-close */
function closeDialogOnBackdrop(dlg){
  dlg.addEventListener('click', (e)=>{
    const rect = dlg.getBoundingClientRect();
    const inDialog = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
    if(!inDialog) dlg.close('cancel');
  });
  dlg.addEventListener('keydown', (e)=>{ if(e.key==='Escape') dlg.close('cancel'); });
}
$$('dialog').forEach(closeDialogOnBackdrop);
document.addEventListener('click', (e)=>{
  const cbtn = e.target.closest('[data-close]');
  if(cbtn){ cbtn.closest('dialog')?.close('cancel'); }
});

/* Helpers */
/* Session rows (enroll form) */
function addSessionRow(v={dt:'',duration:''}){
  const wrap = document.getElementById('sessionList'); if(!wrap) return;
  const row = document.createElement('div');
  row.className = 'sess-row';
  row.innerHTML = `<div class="grid2">
      <label>Tarih & Saat <input type="datetime-local" class="sess-dt" step="900" value="${v.dt? new Date(v.dt).toISOString().slice(0,16) : ''}"></label>
      <label>Süre (dk, opsiyonel) <input type="number" class="sess-dur" min="15" step="15" placeholder="" value="${v.duration ?? ''}"></label>
    </div>
    <div><button class="btn-outline sess-del" type="button">Sil</button></div>`;
  wrap.appendChild(row);
  row.querySelector('.sess-del').onclick = ()=> row.remove();
}
function readSessions(){
  const wrap = document.getElementById('sessionList'); if(!wrap) return [];
  const out = [];
  wrap.querySelectorAll('.sess-row').forEach(r=>{
    const dt = r.querySelector('.sess-dt').value;
    const dur = r.querySelector('.sess-dur').value;
    if(dt){ out.push({ dt: new Date(dt).toISOString(), duration: dur? Number(dur) : null }); }
  });
  return out.slice(0,4);
}
function fillSessions(arr){
  const wrap = document.getElementById('sessionList'); if(!wrap) return;
  wrap.innerHTML = '';
  (arr||[]).slice(0,4).forEach(v=> addSessionRow(v));
}
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='addSession'){ addSessionRow(); }
});

function byId(arr, id){ return (arr||[]).find(x=>x.id===id); }
function table(headers, rows){
  return `<table class="table">
    <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
    <tbody>${rows.join('') || `<tr><td colspan="${headers.length}"><i>Boş</i></td></tr>`}</tbody>
  </table>`;
}
function monthKey(d){ const dt=new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`; }

/* Stats & Finance */
function renderStats(){
  const paid = db.payments.reduce((s,p)=>s+Number(p.amount||0),0);
  $('#stats').innerHTML = `
    <div class="card"><strong>Öğrenci</strong><div>${db.students.length}</div></div>
    <div class="card"><strong>Öğretmen</strong><div>${db.teachers.length}</div></div>
    <div class="card"><strong>Ders</strong><div>${db.courses.length}</div></div>
    <div class="card"><strong>Toplam Tahsilat</strong><div>${TL(paid)}</div></div>`;

  const mo = monthKey(new Date());
  const exp = db.enrollments.reduce((s,e)=>{
    const c=byId(db.courses,e.courseId); if(!c) return s; return s + Number(c.price||0);
  },0);
  const paidM = db.payments.filter(p=>monthKey(p.date)===mo).reduce((s,p)=>s+Number(p.amount||0),0);
  $('#financeSummary').innerHTML = `<b>${mo}</b> Beklenen: ${TL(exp)} — Ödenen: ${TL(paidM)} — Fark: ${TL(exp-paidM)}`;
}

/* Students */
function renderStudents(){
  const q = ($('#studentSearch')?.value||'').toLowerCase();
  const arr = db.students.filter(s=>[s.name,s.email,s.phone].join(' ').toLowerCase().includes(q));
  const rows = arr.map(s=>`
    <tr>
      <td>${s.name}</td><td>${s.phone||''}</td><td>${s.email||''}</td>
      <td class="row-actions">
        <button class="btn-outline" data-edit-student="${s.id}">Düzenle</button>
        <button class="btn-outline" data-del-student="${s.id}">Sil</button>
      </td>
    </tr>`);
  $('#studentTable').innerHTML = table(['Ad Soyad','Telefon','E-posta',''], rows);
  $$('#studentTable [data-edit-student]').forEach(b=>b.onclick=()=>openStudent(byId(db.students,b.dataset.editStudent)));
  $$('#studentTable [data-del-student]').forEach(b=>b.onclick=()=>{ if(confirm('Silinsin mi?')){ 
    db.enrollments = db.enrollments.filter(e=>e.studentId!==b.dataset.delStudent);
    db.payments = db.payments.filter(p=>p.studentId!==b.dataset.delStudent);
    db.students = db.students.filter(x=>x.id!==b.dataset.delStudent);
    store.save(db); renderAll(); } });
}
$('#studentSearch')?.addEventListener('input', ()=>renderStudents());

function openStudent(data){
  const dlg = $('#studentModal'), f = $('#studentForm'); f.reset();
  if(data){ f.id.value=data.id; f.name.value=data.name; f.phone.value=data.phone||''; f.email.value=data.email||''; }
  dlg.showModal();
}
$('#studentForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const f = e.target;
  const item = { id:f.id.value||uid(), name:f.name.value.trim(), phone:f.phone.value.trim(), email:f.email.value.trim() };
  if(!item.name) return;
  const i = db.students.findIndex(x=>x.id===item.id);
  if(i>-1) db.students[i]=item; else db.students.push(item);
  store.save(db); $('#studentModal').close('submit'); renderAll();
});

/* Teachers */
function renderTeachers(){
  const q = ($('#teacherSearch')?.value||'').toLowerCase();
  const arr = db.teachers.filter(t=>[t.name,t.expertise].join(' ').toLowerCase().includes(q));
  const rows = arr.map(t=>`
    <tr>
      <td>${t.name}</td><td>${t.expertise||''}</td><td>${t.share ?? ''}</td>
      <td class="row-actions">
        <button class="btn-outline" data-edit-teacher="${t.id}">Düzenle</button>
        <button class="btn-outline" data-del-teacher="${t.id}">Sil</button>
      </td>
    </tr>`);
  $('#teacherTable').innerHTML = table(['Ad Soyad','Uzmanlık','Pay (%)',''], rows);
  $$('#teacherTable [data-edit-teacher]').forEach(b=>b.onclick=()=>openTeacher(byId(db.teachers,b.dataset.editTeacher)));
  $$('#teacherTable [data-del-teacher]').forEach(b=>b.onclick=()=>{ if(confirm('Silinsin mi?')){
    db.enrollments = db.enrollments.filter(e=>e.teacherId!==b.dataset.delTeacher);
    db.teachers = db.teachers.filter(x=>x.id!==b.dataset.delTeacher);
    store.save(db); renderAll(); } });
}
$('#teacherSearch')?.addEventListener('input', ()=>renderTeachers());

function openTeacher(data){
  const dlg=$('#teacherModal'), f=$('#teacherForm'); f.reset();
  if(data){ f.id.value=data.id; f.name.value=data.name; f.expertise.value=data.expertise||''; f.share.value=(data.share ?? ''); }
  dlg.showModal();
}
$('#teacherForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const f=e.target;
  const item={ id:f.id.value||uid(), name:f.name.value.trim(), expertise:f.expertise.value.trim(), share: f.share.value===''? null : Number(f.share.value) };
  if(!item.name) return;
  const i=db.teachers.findIndex(x=>x.id===item.id);
  if(i>-1) db.teachers[i]=item; else db.teachers.push(item);
  store.save(db); $('#teacherModal').close('submit'); renderAll();
});

/* Courses */
function renderCourses(){
  const q = ($('#courseSearch')?.value||'').toLowerCase();
  const arr = db.courses.filter(c=>c.title.toLowerCase().includes(q));
  const rows = arr.map(c=>`
    <tr>
      <td>${c.title}</td><td>${TL(c.price)}</td>
      <td class="row-actions">
        <button class="btn-outline" data-edit-course="${c.id}">Düzenle</button>
        <button class="btn-outline" data-del-course="${c.id}">Sil</button>
      </td>
    </tr>`);
  $('#courseTable').innerHTML = table(['Ders','Ücret (Aylık)',''], rows);
  $$('#courseTable [data-edit-course]').forEach(b=>b.onclick=()=>openCourse(byId(db.courses,b.dataset.editCourse)));
  $$('#courseTable [data-del-course]').forEach(b=>b.onclick=()=>{ if(confirm('Silinsin mi?')){
    db.payments = db.payments.filter(p=>p.courseId!==b.dataset.delCourse);
    db.enrollments = db.enrollments.filter(e=>e.courseId!==b.dataset.delCourse);
    db.courses = db.courses.filter(x=>x.id!==b.dataset.delCourse);
    store.save(db); renderAll(); } });
}
$('#courseSearch')?.addEventListener('input', ()=>renderCourses());

function openCourse(data){
  const dlg=$('#courseModal'), f=$('#courseForm'); f.reset();
  if(data){ f.id.value=data.id; f.title.value=data.title; f.price.value=data.price; }
  dlg.showModal();
}
$('#courseForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const f=e.target;
  const item={ id:f.id.value||uid(), title:f.title.value.trim(), price:Number(f.price.value||0) };
  if(!item.title) return;
  const i=db.courses.findIndex(x=>x.id===item.id);
  if(i>-1) db.courses[i]=item; else db.courses.push(item);
  store.save(db); $('#courseModal').close('submit'); renderAll();
});

/* Enrollments */
function renderEnrollmentOptions(){
  const sf=$('#enrollForm'); const pf=$('#paymentForm');
  if(sf){
    sf.studentId.innerHTML = db.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    sf.teacherId.innerHTML = db.teachers.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
    sf.courseId.innerHTML = db.courses.map(c=>`<option value="${c.id}">${c.title}</option>`).join('');
  }
  if(pf){
    pf.studentId.innerHTML = db.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    pf.courseId.innerHTML = db.courses.map(c=>`<option value="${c.id}">${c.title}</option>`).join('');
  }
}
function renderEnrollments(){
  renderEnrollmentOptions();
  const q = ($('#enrollSearch')?.value||'').toLowerCase();
  const rows = db.enrollments.filter(e=>{
    const s=byId(db.students,e.studentId)?.name||'';
    const c=byId(db.courses,e.courseId)?.title||'';
    const t=byId(db.teachers,e.teacherId)?.name||'';
    return [s,c,t].join(' ').toLowerCase().includes(q);
  }).map(e=>{
    const st=byId(db.students,e.studentId)?.name||'-';
    const co=byId(db.courses,e.courseId)?.title||'-';
    const te=byId(db.teachers,e.teacherId)?.name||'-';
    const sessTxt = (e.sessions||[]).map(s=>{ try{ const d=new Date(s.dt); return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}` }catch(_){ return '' } }).join(', ');
    return `<tr>
      <td>${st}</td><td>${co}</td><td>${te}</td><td>${e.startDate||''}</td><td>${e.schedule||''}</td><td>${sessTxt}</td><td>${e.duration ?? 60}</td><td>${e.shareOverride ?? ''}</td>
      <td class="row-actions">
        <button class="btn-outline" data-edit-enroll="${e.id}">Düzenle</button>
        <button class="btn-outline" data-del-enroll="${e.id}">Sil</button>
      </td>
    </tr>`;
  });
  $('#enrollmentTable').innerHTML = table(['Öğrenci','Ders','Öğretmen','Başlangıç','Plan','Tekil Tarihler','Süre (dk)','Pay % (kayıt)',''], rows);
  $$('#enrollmentTable [data-edit-enroll]').forEach(b=>b.onclick=()=>openEnroll(byId(db.enrollments,b.dataset.editEnroll)));
  $$('#enrollmentTable [data-del-enroll]').forEach(b=>b.onclick=()=>{ if(confirm('Silinsin mi?')){
    db.enrollments = db.enrollments.filter(x=>x.id!==b.dataset.delEnroll);
    store.save(db); renderAll(); } });
}
function openEnroll(data){
  const dlg=$('#enrollModal'), f=$('#enrollForm'); f.reset(); renderEnrollmentOptions();
  if(data){ f.id.value=data.id; f.studentId.value=data.studentId; f.teacherId.value=data.teacherId; f.courseId.value=data.courseId; f.startDate.value=data.startDate||''; f.schedule.value=data.schedule||''; f.shareOverride.value=(data.shareOverride ?? ''); }
  dlg.showModal();
}
$('#enrollForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const f=e.target;
  const newId = (f.id.value && f.id.value.trim()) ? f.id.value.trim() : uid();
  const item={ id:newId, studentId:f.studentId.value, teacherId:f.teacherId.value, courseId:f.courseId.value, startDate:f.startDate.value, schedule:f.schedule.value.trim(), shareOverride: f.shareOverride.value===''? null : Number(f.shareOverride.value), duration: f.duration.value===''? 60 : Number(f.duration.value), sessions: readSessions() };
  const i=db.enrollments.findIndex(x=>x.id===item.id);
  if(i>-1) db.enrollments[i]=item; else db.enrollments.push(item);
  store.save(db); $('#enrollModal').close('submit'); renderAll();
});

/* Payments */
function renderPayments(){
  const q = ($('#paymentSearch')?.value||'').toLowerCase();
  const rows = db.payments.filter(p=>{
    const s=byId(db.students,p.studentId)?.name||'';
    const c=byId(db.courses,p.courseId)?.title||'';
    return `${s} ${c}`.toLowerCase().includes(q);
  }).map(p=>{
    const s=byId(db.students,p.studentId)?.name||'-';
    const c=byId(db.courses,p.courseId)?.title||'-';
    return `<tr>
      <td>${p.date}</td><td>${s}</td><td>${c}</td><td>${p.method}</td><td>${TL(p.amount)}</td>
      <td class="row-actions">
        <button class="btn-outline" data-edit-payment="${p.id}">Düzenle</button>
        <button class="btn-outline" data-del-payment="${p.id}">Sil</button>
      </td>
    </tr>`;
  });
  $('#paymentTable').innerHTML = table(['Tarih','Öğrenci','Ders','Tip','Tutar',''], rows);
  $$('#paymentTable [data-edit-payment]').forEach(b=>b.onclick=()=>openPayment(byId(db.payments,b.dataset.editPayment)));
  $$('#paymentTable [data-del-payment]').forEach(b=>b.onclick=()=>{ if(confirm('Silinsin mi?')){
    db.payments = db.payments.filter(x=>x.id!==b.dataset.delPayment);
    store.save(db); renderAll(); } });
}
function openPayment(data){
  const dlg=$('#paymentModal'), f=$('#paymentForm'); f.reset(); renderEnrollmentOptions();
  if(data){ f.id.value=data.id; f.studentId.value=data.studentId; f.courseId.value=data.courseId; f.amount.value=data.amount; f.date.value=data.date; f.method.value=data.method; }
  dlg.showModal();
}
$('#paymentForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const f=e.target;
  const item={ id:f.id.value||uid(), studentId:f.studentId.value, courseId:f.courseId.value, amount:Number(f.amount.value||0), date:f.date.value, method:f.method.value };
  const i=db.payments.findIndex(x=>x.id===item.id);
  if(i>-1) db.payments[i]=item; else db.payments.push(item);
  store.save(db); $('#paymentModal').close('submit'); renderAll();
});

/* Payouts */
function teacherShareForEnrollment(enroll){
  if(enroll.shareOverride!=null && enroll.shareOverride!=='') return Number(enroll.shareOverride)/100;
  const t = byId(db.teachers, enroll.teacherId);
  if(t && t.share!=null && t.share!=='') return Number(t.share)/100;
  return Number(db.settings.defaultShare||50)/100;
}
function calcPayouts(filterMonth=null){
  const totals = {}; // teacherId -> amount
  for(const p of db.payments){
    const mo = monthKey(p.date);
    if(filterMonth && mo!==filterMonth) continue;
    const relEnrolls = db.enrollments.filter(e=>e.studentId===p.studentId && e.courseId===p.courseId);
    if(relEnrolls.length===0) continue;
    const perEnroll = Number(p.amount||0)/relEnrolls.length;
    for(const e of relEnrolls){
      const share = teacherShareForEnrollment(e);
      totals[e.teacherId] = (totals[e.teacherId]||0) + perEnroll*share;
    }
  }
  return totals;
}
function renderPayouts(){
  const mo = $('#payoutMonth').value || monthKey(new Date());
  const totals = calcPayouts(mo);
  const rows = Object.entries(totals).map(([tid,amt])=>{
    const t = byId(db.teachers, tid);
    return `<tr><td>${t?.name||'-'}</td><td>${TL(amt)}</td></tr>`;
  });
  $('#payoutTable').innerHTML = table(['Öğretmen','Hakediş'], rows);
}
$('#recalcPayouts')?.addEventListener('click', renderPayouts);

/* Settings */
function renderSettings(){
  const f=$('#settingsForm');
  f.academyName.value = db.settings.academyName;
  f.defaultShare.value = db.settings.defaultShare;
  f.onsubmit = (e)=>{
    e.preventDefault();
    db.settings.academyName = f.academyName.value || "Dilara Pak Sanat Akademi";
    db.settings.defaultShare = Number(f.defaultShare.value||50);
    store.save(db); alert('Ayarlar kaydedildi');
  };
}

/* Render all */
function renderAll(){
  renderStats();
  renderStudents();
  renderTeachers();
  renderCourses();
  renderEnrollments();
  renderPayments();
  renderPayouts();
  renderSettings();
}

/* Open modal buttons (event delegation) */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-open]');
  if(!btn) return;
  const id = btn.getAttribute('data-open');
  if(id==='studentModal') return openStudent();
  if(id==='teacherModal') return openTeacher();
  if(id==='courseModal') return openCourse();
  if(id==='enrollModal') return openEnroll();
  if(id==='paymentModal') return openPayment();
});

/* ===== Calendar (weekly) ===== */
const DAY_NAMES = ['Pzt','Sal','Çar','Per','Cum','Cmt','Paz'];
const DAY_MAP = {
  'pazartesi':0,'pzt':0,'pzt.':0,
  'salı':1,'sali':1,'sal':1,'sal.':1,
  'çarşamba':2,'carsamba':2,'çar':2,'car':2,'çar.':2,'car.':2,
  'perşembe':3,'persembe':3,'per':3,'per.':3,
  'cuma':4,'cum':4,'cum.':4,
  'cumartesi':5,'cmt':5,'cmt.':5,
  'pazar':6,'paz':6,'paz.':6
};
let calWeekStart = getMonday(new Date());
function getMonday(d){ const dt=new Date(d); const day=(dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); dt.setHours(0,0,0,0); return dt; }
function fmtDate(d){ return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`; }

function parseSchedule(s){
  if(!s) return null;
  let txt = (s+'').toLowerCase().replace(/\./g,':').trim();
  let dow = null;
  for(const k in DAY_MAP){ if(txt.includes(k)){ dow = DAY_MAP[k]; break; } }
  const m = txt.match(/(\d{1,2})[:](\d{2})/);
  const m2 = !m && txt.match(/(\d{1,2})\s*$/);
  let hh=17, mm=0;
  if(m){ hh = Number(m[1]); mm = Number(m[2]); }
  else if(m2){ hh = Number(m2[1]); mm = 0; }
  return (dow==null)? null : { dow, hh, mm };
}

function renderCalendar(){
  const header = document.getElementById('calHeader');
  const grid = document.getElementById('calendar');
  if(!header || !grid) return;
  const start = new Date(calWeekStart);
  const end = new Date(calWeekStart); end.setDate(end.getDate()+6);
  document.getElementById('calRange').textContent = `${fmtDate(start)} – ${fmtDate(end)}`;

  const days = [null];
  for(let i=0;i<7;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    days.push(`<div class="cell">${DAY_NAMES[i]} ${d.getDate()}.${String(d.getMonth()+1).padStart(2,'0')}</div>`);
  }
  header.innerHTML = days.join('');

  const HSTART=8, HEND=22, H=48;
  let timeCol = '<div class="cal-timecol">';
  for(let h=HSTART; h<=HEND; h++){ timeCol += `<div class="cal-time">${String(h).padStart(2,'0')}:00</div>`; }
  timeCol += '</div>';
  const dayCols = [];
  for(let i=0;i<7;i++){
    let col = '<div class="cal-day" style="height:' + ((HEND-HSTART+1)*H) + 'px">';
    for(let h=HSTART; h<=HEND; h++){ col += `<div class="cal-hour"></div>`; }
    for(const e of db.enrollments){
      // Sessions (exact dates)
      const sessions = (e.sessions||[]).map(s=>{ try{ return {d:new Date(s.dt), dur: (s.duration ?? e.duration ?? 60)} }catch(_){ return null } }).filter(Boolean);
      for(const s of sessions){
        const test = new Date(start); test.setDate(start.getDate()+i);
        if(s.d.getFullYear()===test.getFullYear() && s.d.getMonth()===test.getMonth() && s.d.getDate()===test.getDate()){
          const top = ((s.d.getHours() - HSTART) * H) + (s.d.getMinutes()/60)*H;
          const height = Math.max(24, H * (Number(s.dur)/60));
          const stu = byId(db.students, e.studentId)?.name || 'Öğrenci';
          const tea = byId(db.teachers, e.teacherId)?.name || 'Öğretmen';
          const cou = byId(db.courses, e.courseId)?.title || 'Ders';
          col += `<div class="event" style="top:${top}px;height:${height}px">
            <div class="title">${stu} <span class="badge">${cou}</span></div>
            <div class="meta">${tea} · ${String(s.d.getHours()).padStart(2,'0')}:${String(s.d.getMinutes()).padStart(2,'0')}</div>
          </div>`;
        }
      }
      // Recurring schedule
      const parsed = parseSchedule(e.schedule);
      if(parsed && parsed.dow===i){
        const dur = Number(e.duration||60);
        const top = ((parsed.hh - HSTART) * H) + (parsed.mm/60)*H;
        const height = Math.max(24, H * (dur/60));
        const stu = byId(db.students, e.studentId)?.name || 'Öğrenci';
        const tea = byId(db.teachers, e.teacherId)?.name || 'Öğretmen';
        const cou = byId(db.courses, e.courseId)?.title || 'Ders';
        col += `<div class="event" style="top:${top}px;height:${height}px">
          <div class="title">${stu} <span class="badge">${cou}</span></div>
          <div class="meta">${tea} · ${String(parsed.hh).padStart(2,'0')}:${String(parsed.mm).padStart(2,'0')}</div>
        </div>`;
      }
    }
    col += '</div>';
    dayCols.push(col);
  }
  grid.innerHTML = timeCol + dayCols.join('');
}
document.getElementById('calPrev')?.addEventListener('click', ()=>{ calWeekStart.setDate(calWeekStart.getDate()-7); renderCalendar(); });
document.getElementById('calNext')?.addEventListener('click', ()=>{ calWeekStart.setDate(calWeekStart.getDate()+7); renderCalendar(); });
document.getElementById('calToday')?.addEventListener('click', ()=>{ calWeekStart = getMonday(new Date()); renderCalendar(); });

// Hook into renderAll
const _renderAll = renderAll;
renderAll = function(){ _renderAll(); renderCalendar(); };

    
// ===== Calendar v15.3 (week/month) =====
var calMode = 'week';
var calRefDate = new Date();

function fmt2(n){ return String(n).padStart(2,'0'); }
function fmtTime(h,m){ return fmt2(h)+':'+fmt2(m); }
function getMonday(d){ const dt=new Date(d); const day=(dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); dt.setHours(0,0,0,0); return dt; }
const DAY_SHORT = ['Pzt','Sal','Çar','Per','Cum','Cmt','Paz'];
const DAY_MAP = { 'pazartesi':0,'pzt':0,'pzt.':0,'salı':1,'sali':1,'sal':1,'sal.':1,'çarşamba':2,'carsamba':2,'çar':2,'car':2,'çar.':2,'car.':2,'perşembe':3,'persembe':3,'per':3,'per.':3,'cuma':4,'cum':4,'cum.':4,'cumartesi':5,'cmt':5,'cmt.':5,'pazar':6,'paz':6,'paz.':6 };
function parseSchedule(s){
  if(!s) return null;
  let t=(s+'').toLowerCase().replace(/\./g,':').trim(), dow=null;
  for(const k in DAY_MAP){ if(t.includes(k)){ dow=DAY_MAP[k]; break; } }
  const m=t.match(/(\d{1,2})[:](\d{2})/) || t.match(/(\d{1,2})\s*$/);
  let hh=17, mm=0; if(m){ hh=Number(m[1]); mm=Number(m[2]||0); }
  return dow==null? null : {dow,hh,mm};
}
function setMode(m){
  calMode=m;
  document.getElementById('modeWeek')?.classList.toggle('active', m==='week');
  document.getElementById('modeMonth')?.classList.toggle('active', m==='month');
  renderCalendar();
}
document.addEventListener('click', (e)=>{
  if(e.target?.id==='modeWeek') setMode('week');
  if(e.target?.id==='modeMonth') setMode('month');
});
document.getElementById('calPrev')?.addEventListener('click', ()=>{ calRefDate.setDate(calRefDate.getDate() + (calMode==='week'?-7: -30)); renderCalendar(); });
document.getElementById('calNext')?.addEventListener('click', ()=>{ calRefDate.setDate(calRefDate.getDate() + (calMode==='week'?+7:+30)); renderCalendar(); });
document.getElementById('calToday')?.addEventListener('click', ()=>{ calRefDate=new Date(); renderCalendar(); });

function renderCalendar(){
  if(location.hash!=='#dashboard') return;
  if(calMode==='week') return renderWeek();
  return renderMonth();
}
function renderWeek(){
  const header=document.getElementById('calHeader'); const grid=document.getElementById('calendar');
  if(!header||!grid) return;
  header.style.display='grid'; grid.style.display='grid'; document.getElementById('monthHeader')?.remove(); document.getElementById('monthGrid')?.remove();
  const start=getMonday(calRefDate); const end=new Date(start); end.setDate(end.getDate()+6);
  document.getElementById('calRange').textContent = fmt2(start.getDate())+'.'+fmt2(start.getMonth()+1)+' – '+fmt2(end.getDate())+'.'+fmt2(end.getMonth()+1);
  const days=[null]; for(let i=0;i<7;i++){ const d=new Date(start); d.setDate(start.getDate()+i); days.push('<div class="cell">'+DAY_SHORT[i]+' '+fmt2(d.getDate())+'.'+fmt2(d.getMonth()+1)+'</div>'); } header.innerHTML=days.join('');
  const HSTART=8,HEND=22,H=48; let timeCol='<div class="cal-timecol">'; for(let h=HSTART;h<=HEND;h++) timeCol+='<div class="cal-time">'+fmt2(h)+':00</div>'; timeCol+='</div>';
  const dayCols=[]; for(let i=0;i<7;i++){ let col='<div class="cal-day" style="height:'+((HEND-HSTART+1)*H)+'px">'; for(let h=HSTART;h<=HEND;h++) col+='<div class="cal-hour"></div>';
    for(const e of db.enrollments){
      const sessions=(e.sessions||[]).map(s=>{ try{ return {d:new Date(s.dt), dur:(s.duration??e.duration??60)} }catch(_){ return null } }).filter(Boolean);
      for(const s of sessions){ const d0=new Date(start); d0.setDate(start.getDate()+i); if(s.d.toDateString()===d0.toDateString()){ const top=((s.d.getHours()-HSTART)*H)+(s.d.getMinutes()/60)*H; const height=Math.max(36,H*(Number(s.dur)/60)); const stu=byId(db.students,e.studentId)?.name||'Öğrenci'; const tea=byId(db.teachers,e.teacherId)?.name||'Öğretmen'; const cou=byId(db.courses,e.courseId)?.title||'Ders'; col+=`<div class="event" style="top:${top}px;height:${height}px"><div class="title">${stu} <span class="badge">${cou}</span></div><div class="meta">${tea} · ${fmtTime(s.d.getHours(),s.d.getMinutes())}</div></div>`; } }
      const p=parseSchedule(e.schedule); if(p && p.dow===i){ const top=((p.hh-HSTART)*H)+(p.mm/60)*H; const height=Math.max(36,H*((e.duration||60)/60)); const stu=byId(db.students,e.studentId)?.name||'Öğrenci'; const tea=byId(db.teachers,e.teacherId)?.name||'Öğretmen'; const cou=byId(db.courses,e.courseId)?.title||'Ders'; col+=`<div class="event" style="top:${top}px;height:${height}px"><div class="title">${stu} <span class="badge">${cou}</span></div><div class="meta">${tea} · ${fmtTime(p.hh,p.mm)}</div></div>`; }
    } col+='</div>'; dayCols.push(col); }
  grid.innerHTML=timeCol+dayCols.join('');
}
function renderMonth(){
  const container=document.getElementById('calendar'); const header=document.getElementById('calHeader'); if(!container||!header) return;
  header.style.display='none'; container.style.display='block'; document.getElementById('monthHeader')?.remove(); document.getElementById('monthGrid')?.remove();
  const mh=document.createElement('div'); mh.id='monthHeader'; mh.className='month-header'; for(let i=0;i<7;i++) mh.innerHTML+='<div class="cell">'+DAY_SHORT[i]+'</div>'; header.parentNode.insertBefore(mh, container);
  const first=new Date(calRefDate.getFullYear(), calRefDate.getMonth(), 1); const start=getMonday(first); const grid=document.createElement('div'); grid.id='monthGrid'; grid.className='month-grid';
  for(let i=0;i<42;i++){ const d=new Date(start); d.setDate(start.getDate()+i); const cell=document.createElement('div'); cell.className='month-cell'; const inMonth=d.getMonth()===calRefDate.getMonth(); cell.innerHTML='<div class="mday" style="opacity:'+(inMonth?1:.5)+'">'+fmt2(d.getDate())+'</div>';
    for(const e of db.enrollments){ const sessions=(e.sessions||[]).map(s=>{ try{ return {d:new Date(s.dt), dur:(s.duration??e.duration??60)} }catch(_){ return null } }).filter(Boolean);
      for(const s of sessions){ if(s.d.toDateString()===d.toDateString()){ const stu=byId(db.students,e.studentId)?.name||'Öğrenci'; const cou=byId(db.courses,e.courseId)?.title||'Ders'; cell.innerHTML += '<span class="pill">'+fmtTime(s.d.getHours(),s.d.getMinutes())+' · '+stu+' <span class="badge">'+cou+'</span></span>'; } }
      const p=parseSchedule(e.schedule); if(p && ((d.getDay()+6)%7)===p.dow){ const stu=byId(db.students,e.studentId)?.name||'Öğrenci'; const cou=byId(db.courses,e.courseId)?.title||'Ders'; cell.innerHTML += '<span class="pill">'+fmtTime(p.hh,p.mm)+' · '+stu+' <span class="badge">'+cou+'</span></span>'; }
    } grid.appendChild(cell); }
  container.parentNode.insertBefore(grid, container.nextSibling);
}
// re-render when data changes or hash changes
window.addEventListener('hashchange', ()=>{ if(location.hash==='#dashboard') setTimeout(renderCalendar,0); });
const _renderAll_v153 = renderAll; renderAll = function(){ _renderAll_v153(); if(location.hash==='#dashboard') renderCalendar(); };
setTimeout(renderCalendar,0);
if (typeof showPage === 'function') showPage(location.hash||'#dashboard');
    console.log('DPSA v14.1 init done');
  } catch(err) {
    console.error('DPSA v14.1 init error:', err);
  }
});

</script>
</body>
</html>
